name: Terraform + Ansible GCP Setup

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      ANSIBLE_HOST_KEY_CHECKING: 'False'  # Disable SSH host key check

    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v3

    - name: â˜ï¸ Set up Terraform
      uses: hashicorp/setup-terraform@v3

    - name: ðŸ—ï¸ Create SSH Key
      run: |
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > $HOME/id_rsa
        chmod 600 $HOME/id_rsa
        echo "${{ secrets.SSH_PUBLIC_KEY }}" > $HOME/id_rsa.pub

    - name: ðŸ§¾ Write GCP Credentials
      run: |
        echo '${{ secrets.GOOGLE_CREDENTIALS }}' > $HOME/credentials.json

    - name: âš™ï¸ Terraform Init
      working-directory: terraform
      run: terraform init

    - name: ðŸ“¦ Terraform Apply
      working-directory: terraform
      run: terraform apply -auto-approve \
        -var="gcp_credentials_file=$HOME/credentials.json" \
        -var="ssh_pub_key_path=$HOME/id_rsa.pub" \
        -var="ssh_user=ubuntu"

    - name: ðŸŒ Get VM IP
      id: vm_ip
      working-directory: terraform
      run: echo "VM_IP=$(terraform output -raw vm_ip)" >> $GITHUB_ENV

    - name: ðŸ“¦ Install Docker with Ansible
      run: |
        ansible-playbook -i ansible/inventory.ini ansible/install-docker.yaml --private-key $HOME/id_rsa -u ubuntu -e "ansible_host=${{ env.VM_IP }}"
