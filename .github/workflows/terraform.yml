name: Terraform + Ansible Docker Setup

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      ANSIBLE_HOST_KEY_CHECKING: False

    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v3

      - name: 🗝️ Write SSH Private Key to File
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > $HOME/id_rsa
          chmod 600 $HOME/id_rsa

      - name: 🔑 Write SSH Public Key to File
        run: |
          echo "${{ secrets.SSH_PUBLIC_KEY }}" > $HOME/id_rsa.pub
          chmod 644 $HOME/id_rsa.pub

      - name: ☁️ Write GCP Credentials to File
        run: |
          echo '${{ secrets.GOOGLE_CREDENTIALS }}' > $HOME/credentials.json

      - name: 📦 Set up Terraform
        uses: hashicorp/setup-terraform@v3

      - name: 🌍 Terraform Init
        working-directory: terraform
        run: terraform init

      - name: 🚀 Terraform Apply
        working-directory: terraform
        run: |
          terraform apply -auto-approve \
            -var="gcp_credentials_file=$HOME/credentials.json" \
            -var="ssh_pub_key_path=$HOME/id_rsa.pub" \
            -var="ssh_user=ubuntu"

      - name: 📡 Get VM IP
        id: get_ip
        working-directory: terraform
        run: |
          echo "VM_IP=$(terraform output -raw vm_ip)" >> $GITHUB_ENV

      - name: 🧾 Create Inventory File
        run: |
          echo "[vm]" > ansible/inventory.ini
          echo "$VM_IP ansible_user=ubuntu ansible_ssh_private_key_file=$HOME/id_rsa" >> ansible/inventory.ini

      - name: 🐳 Install Docker with Ansible
        run: |
          ansible-playbook -i ansible/inventory.ini ansible/install-docker.yaml
